<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sky AI Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;700&family=Josefin+Sans:wght@200;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --sky-dawn: #ffd4a3; --sky-morning: #87ceeb; --sky-noon: #4a90d9;
    --sky-deep: #1a3a6b; --sky-night: #0a0f2e; --gold: #f5c842;
    --text-light: rgba(255,255,255,0.95); --text-dim: rgba(255,255,255,0.6);
    --glass: rgba(255,255,255,0.12); --glass-border: rgba(255,255,255,0.25);
    --sidebar-w: 260px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Zen Kaku Gothic New',sans-serif; background:var(--sky-night); color:var(--text-light); height:100vh; overflow:hidden; display:flex; }

  #sky-bg {
    position:fixed; inset:0; z-index:0;
    background:linear-gradient(180deg,#0a0f2e 0%,#1a3a6b 30%,#2d6fa4 55%,#87ceeb 78%,#b8e4f5 90%,#ffe8cc 100%);
    animation:skyShift 20s ease-in-out infinite alternate;
  }
  @keyframes skyShift {
    0%   { filter:hue-rotate(0deg) brightness(0.9); }
    50%  { filter:hue-rotate(15deg) brightness(1.05); }
    100% { filter:hue-rotate(-10deg) brightness(0.95); }
  }
  #stars { position:fixed; inset:0; z-index:1; pointer-events:none; }
  .star { position:absolute; border-radius:50%; background:white; animation:twinkle var(--d) ease-in-out infinite alternate; }
  @keyframes twinkle { from{opacity:0.1;transform:scale(0.8);} to{opacity:0.9;transform:scale(1.2);} }
  .cloud { position:fixed; z-index:2; pointer-events:none; background:radial-gradient(ellipse,rgba(255,255,255,0.6) 0%,transparent 70%); border-radius:50%; animation:cloudDrift var(--cd) linear infinite; }
  @keyframes cloudDrift { from{transform:translateX(-200px);} to{transform:translateX(calc(100vw + 200px));} }

  #app { position:relative; z-index:10; display:flex; width:100%; height:100vh; }

  /* SIDEBAR */
  #sidebar { width:var(--sidebar-w); background:rgba(10,15,46,0.75); backdrop-filter:blur(20px); border-right:1px solid var(--glass-border); display:flex; flex-direction:column; flex-shrink:0; }
  #sidebar-header { padding:24px 20px 16px; border-bottom:1px solid var(--glass-border); }
  .logo { font-family:'Josefin Sans',sans-serif; font-size:22px; font-weight:600; letter-spacing:2px; background:linear-gradient(135deg,#87ceeb,#ffd4a3,#fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:4px; }
  .logo-sub { font-size:10px; letter-spacing:3px; color:var(--text-dim); text-transform:uppercase; }
  .logo-badge { display:inline-block; margin-top:4px; font-size:9px; letter-spacing:2px; padding:2px 8px; border-radius:20px; background:linear-gradient(135deg,rgba(16,163,127,0.4),rgba(16,163,127,0.2)); border:1px solid rgba(16,163,127,0.5); color:#4ade80; }

  #new-chat-btn { margin:12px 16px 0; padding:10px 16px; background:linear-gradient(135deg,rgba(74,144,217,0.4),rgba(135,206,235,0.2)); border:1px solid var(--glass-border); border-radius:12px; color:white; font-family:inherit; font-size:13px; cursor:pointer; display:flex; align-items:center; gap:8px; transition:all 0.2s; }
  #new-chat-btn:hover { background:rgba(135,206,235,0.35); transform:translateY(-1px); }

  #mode-tabs { display:flex; flex-direction:column; gap:2px; padding:12px 10px; border-bottom:1px solid var(--glass-border); }
  .mode-tab { padding:9px 12px; border-radius:10px; cursor:pointer; font-size:12px; letter-spacing:0.5px; display:flex; align-items:center; gap:10px; transition:all 0.2s; color:var(--text-dim); border:1px solid transparent; }
  .mode-tab:hover { background:var(--glass); color:white; }
  .mode-tab.active { background:linear-gradient(135deg,rgba(74,144,217,0.5),rgba(135,206,235,0.2)); border-color:var(--glass-border); color:white; }
  .mode-icon { font-size:16px; min-width:20px; text-align:center; }

  #history-list { flex:1; overflow-y:auto; padding:10px; }
  #history-list::-webkit-scrollbar { width:4px; }
  #history-list::-webkit-scrollbar-thumb { background:var(--glass-border); border-radius:2px; }
  .history-section-label { font-size:10px; letter-spacing:2px; color:var(--text-dim); padding:8px 6px 4px; text-transform:uppercase; display:flex; align-items:center; justify-content:space-between; }
  .clear-all-btn { font-size:10px; color:rgba(255,100,100,0.6); cursor:pointer; padding:2px 6px; border-radius:4px; border:none; background:none; font-family:inherit; transition:all 0.2s; }
  .clear-all-btn:hover { color:rgba(255,100,100,1); background:rgba(255,100,100,0.1); }

  .history-item { padding:8px 10px; border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-dim); transition:all 0.15s; display:flex; align-items:center; gap:6px; position:relative; }
  .history-item:hover { background:var(--glass); color:white; }
  .history-item.active { background:rgba(74,144,217,0.25); color:white; }
  .history-item-icon { flex-shrink:0; font-size:13px; }
  .history-item-title { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .history-actions { display:none; align-items:center; gap:2px; flex-shrink:0; }
  .history-item:hover .history-actions, .history-item.active .history-actions { display:flex; }
  .h-action-btn { width:22px; height:22px; border-radius:5px; border:none; background:none; color:var(--text-dim); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:11px; transition:all 0.15s; }
  .h-action-btn:hover { background:rgba(255,255,255,0.15); color:white; }
  .h-action-btn.delete:hover { background:rgba(255,80,80,0.3); color:#ff9090; }
  .separator { height:1px; background:var(--glass-border); margin:8px 10px; }

  /* MAIN */
  #main { flex:1; display:flex; flex-direction:column; min-width:0; }
  #topbar { padding:14px 24px; background:rgba(10,15,46,0.5); backdrop-filter:blur(10px); border-bottom:1px solid var(--glass-border); display:flex; align-items:center; justify-content:space-between; gap:10px; }
  #mode-title { font-family:'Josefin Sans',sans-serif; font-size:15px; letter-spacing:2px; color:var(--text-light); }
  .topbar-right { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  #model-select { background:var(--glass); border:1px solid var(--glass-border); color:white; font-family:inherit; font-size:11px; padding:6px 12px; border-radius:20px; cursor:pointer; letter-spacing:1px; }
  #model-select option { background:#1a3a6b; }
  .icon-btn { width:34px; height:34px; border-radius:10px; background:var(--glass); border:1px solid var(--glass-border); color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:15px; transition:all 0.2s; }
  .icon-btn:hover { background:rgba(255,255,255,0.2); }
  /* TTS toggle */
  #tts-btn.active { background:rgba(16,163,127,0.3); border-color:rgba(16,163,127,0.6); }

  /* Chat area */
  #chat-area { flex:1; overflow-y:auto; padding:24px; display:flex; flex-direction:column; gap:16px; }
  #chat-area::-webkit-scrollbar { width:4px; }
  #chat-area::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.15); border-radius:2px; }

  /* Welcome */
  #welcome { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:40px; gap:20px; }
  .welcome-logo { font-family:'Josefin Sans',sans-serif; font-size:46px; font-weight:200; letter-spacing:8px; background:linear-gradient(135deg,#87ceeb 0%,#ffd4a3 50%,#fff 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation:logoGlow 4s ease-in-out infinite alternate; }
  @keyframes logoGlow { from{filter:drop-shadow(0 0 20px rgba(135,206,235,0.5));} to{filter:drop-shadow(0 0 40px rgba(255,212,163,0.6));} }
  .welcome-sub { font-size:12px; letter-spacing:3px; color:var(--text-dim); text-transform:uppercase; }
  .welcome-powered { font-size:11px; color:rgba(16,163,127,0.8); letter-spacing:2px; }
  .quick-actions { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px; width:100%; max-width:500px; }
  .quick-btn { padding:14px; border-radius:16px; background:var(--glass); border:1px solid var(--glass-border); color:white; font-family:inherit; font-size:12px; cursor:pointer; text-align:left; line-height:1.5; transition:all 0.2s; }
  .quick-btn:hover { background:rgba(255,255,255,0.18); transform:translateY(-2px); }
  .quick-btn .qb-icon { font-size:20px; margin-bottom:6px; display:block; }

  /* Messages */
  .msg { display:flex; gap:12px; animation:msgIn 0.3s ease; }
  @keyframes msgIn { from{opacity:0;transform:translateY(12px);} to{opacity:1;transform:translateY(0);} }
  .msg.user { flex-direction:row-reverse; }
  .msg-avatar { width:36px; height:36px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:16px; }
  .msg.ai .msg-avatar { background:linear-gradient(135deg,#10a37f,#1a7a5e); }
  .msg.user .msg-avatar { background:linear-gradient(135deg,#f5c842,#ffd4a3); }
  .msg-bubble { max-width:72%; padding:14px 18px; border-radius:18px; font-size:14px; line-height:1.75; }
  .msg.ai .msg-bubble { background:rgba(16,163,127,0.15); border:1px solid rgba(16,163,127,0.3); border-top-left-radius:4px; }
  .msg.user .msg-bubble { background:linear-gradient(135deg,rgba(245,200,66,0.2),rgba(255,212,163,0.15)); border:1px solid rgba(255,212,163,0.3); border-top-right-radius:4px; }

  /* Markdown-ish rendering */
  .msg-bubble strong { color:#87ceeb; }
  .msg-bubble code { background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px; font-family:monospace; font-size:12px; }
  .msg-bubble pre { background:rgba(0,0,0,0.3); padding:12px; border-radius:8px; overflow-x:auto; margin:8px 0; }
  .msg-bubble pre code { background:none; padding:0; }

  /* File preview */
  .file-preview-msg { display:flex; align-items:center; gap:8px; background:rgba(0,0,0,0.2); border-radius:10px; padding:8px 12px; margin-bottom:8px; font-size:12px; border:1px solid var(--glass-border); }
  .file-preview-msg .fp-icon { font-size:18px; }
  .file-preview-msg .fp-name { color:white; font-size:12px; }
  .file-preview-msg .fp-size { font-size:10px; color:var(--text-dim); }
  .file-preview-msg img { max-width:220px; max-height:160px; border-radius:8px; object-fit:cover; }

  /* DALL-E image result */
  .dalle-result { margin-top:10px; }
  .dalle-result img { max-width:100%; border-radius:12px; display:block; margin-bottom:8px; box-shadow:0 4px 20px rgba(0,0,0,0.4); }

  /* Gen preview */
  .gen-preview { margin-top:12px; padding:12px; border-radius:12px; background:rgba(0,0,0,0.3); border:1px solid var(--glass-border); font-size:12px; color:var(--text-dim); }
  .download-btn { display:inline-flex; align-items:center; gap:6px; margin-top:10px; padding:8px 16px; border-radius:20px; background:linear-gradient(135deg,#10a37f,#0d7a5f); color:white; font-size:12px; cursor:pointer; border:none; font-family:inherit; transition:all 0.2s; }
  .download-btn:hover { transform:scale(1.03); opacity:0.9; }

  /* Audio player */
  .audio-player { margin-top:10px; width:100%; }
  .audio-player audio { width:100%; border-radius:8px; }

  /* Typing */
  .typing-dots { display:flex; gap:5px; padding:8px 0; }
  .typing-dots span { width:8px; height:8px; border-radius:50%; background:rgba(16,163,127,0.7); animation:bounce 1.2s ease-in-out infinite; }
  .typing-dots span:nth-child(2) { animation-delay:0.2s; }
  .typing-dots span:nth-child(3) { animation-delay:0.4s; }
  @keyframes bounce { 0%,60%,100%{transform:translateY(0);} 30%{transform:translateY(-8px);} }

  /* INPUT AREA */
  #input-area { padding:12px 24px 18px; background:rgba(10,15,46,0.6); backdrop-filter:blur(20px); border-top:1px solid var(--glass-border); }
  #mode-options { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
  .option-chip { padding:4px 12px; border-radius:20px; font-size:11px; background:var(--glass); border:1px solid var(--glass-border); color:var(--text-dim); cursor:pointer; letter-spacing:0.5px; transition:all 0.2s; }
  .option-chip:hover, .option-chip.selected { background:rgba(16,163,127,0.35); color:white; border-color:rgba(16,163,127,0.5); }

  #attachments-bar { display:none; gap:8px; margin-bottom:8px; flex-wrap:wrap; align-items:center; }
  #attachments-bar.has-files { display:flex; }
  .attach-chip { display:flex; align-items:center; gap:6px; background:rgba(16,163,127,0.2); border:1px solid rgba(16,163,127,0.4); border-radius:20px; padding:4px 10px 4px 8px; font-size:11px; color:white; max-width:180px; }
  .attach-chip-icon { font-size:14px; flex-shrink:0; }
  .attach-chip-name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; }
  .attach-chip-remove { flex-shrink:0; cursor:pointer; color:rgba(255,255,255,0.5); width:16px; height:16px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; transition:all 0.15s; border:none; background:none; font-family:inherit; }
  .attach-chip-remove:hover { color:white; background:rgba(255,80,80,0.4); }

  #input-row { display:flex; gap:8px; align-items:flex-end; }
  #msg-input { flex:1; min-height:48px; max-height:160px; background:var(--glass); border:1px solid var(--glass-border); border-radius:16px; padding:12px 16px; color:white; font-family:inherit; font-size:14px; resize:none; outline:none; line-height:1.5; transition:border-color 0.2s; }
  #msg-input::placeholder { color:var(--text-dim); }
  #msg-input:focus { border-color:rgba(16,163,127,0.6); }

  .input-btn { width:46px; height:46px; border-radius:14px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; transition:all 0.2s; flex-shrink:0; }
  #attach-btn { background:var(--glass); border:1px solid var(--glass-border); color:white; }
  #attach-btn:hover { background:rgba(255,255,255,0.2); }
  #voice-btn { background:var(--glass); border:1px solid var(--glass-border); color:white; }
  #voice-btn:hover { background:rgba(255,100,100,0.3); }
  #voice-btn.recording { background:rgba(255,60,60,0.45); animation:pulse 1s ease-in-out infinite alternate; }
  @keyframes pulse { from{box-shadow:0 0 0 rgba(255,100,100,0.5);} to{box-shadow:0 0 16px rgba(255,100,100,0.5);} }
  #send-btn { background:linear-gradient(135deg,#10a37f,#0d7a5f); color:white; }
  #send-btn:hover { transform:scale(1.05); opacity:0.9; }
  #send-btn:disabled { opacity:0.35; cursor:not-allowed; transform:none; }
  #file-input { display:none; }
  .input-hint { font-size:10px; color:var(--text-dim); letter-spacing:0.5px; margin-top:7px; text-align:center; }

  /* MODALS */
  .modal-overlay { display:none; position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal-box { background:linear-gradient(135deg,rgba(26,58,107,0.97),rgba(10,15,46,0.99)); border:1px solid var(--glass-border); border-radius:24px; padding:32px; width:90%; max-width:440px; }
  .modal-title { font-family:'Josefin Sans',sans-serif; font-size:18px; letter-spacing:2px; margin-bottom:8px; background:linear-gradient(135deg,#87ceeb,#ffd4a3); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .modal-desc { font-size:12px; color:var(--text-dim); margin-bottom:20px; line-height:1.7; }
  .modal-input { width:100%; padding:12px 16px; border-radius:12px; background:var(--glass); border:1px solid var(--glass-border); color:white; font-family:inherit; font-size:13px; outline:none; margin-bottom:12px; }
  .modal-input:focus { border-color:rgba(16,163,127,0.6); }
  .modal-label { font-size:11px; color:var(--text-dim); margin-bottom:6px; letter-spacing:1px; display:block; }
  .modal-btn { width:100%; padding:12px; border-radius:12px; border:none; background:linear-gradient(135deg,#10a37f,#0d7a5f); color:white; font-family:inherit; font-size:14px; cursor:pointer; letter-spacing:1px; transition:opacity 0.2s; }
  .modal-btn:hover { opacity:0.85; }
  .modal-btn.danger { background:linear-gradient(135deg,rgba(200,50,50,0.8),rgba(255,80,80,0.6)); }
  .modal-btn.secondary { background:var(--glass); border:1px solid var(--glass-border); }
  .modal-btn-row { display:flex; gap:10px; }
  .modal-btn-row .modal-btn { flex:1; }
  .modal-note { font-size:11px; color:var(--text-dim); text-align:center; margin-top:10px; }
  .modal-divider { height:1px; background:var(--glass-border); margin:16px 0; }

  /* Context menu */
  #ctx-menu { position:fixed; z-index:300; background:rgba(10,20,60,0.96); backdrop-filter:blur(16px); border:1px solid var(--glass-border); border-radius:12px; padding:6px; min-width:160px; display:none; flex-direction:column; gap:2px; box-shadow:0 8px 32px rgba(0,0,0,0.5); }
  #ctx-menu.open { display:flex; }
  .ctx-item { padding:9px 14px; border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-light); display:flex; align-items:center; gap:10px; transition:background 0.15s; }
  .ctx-item:hover { background:var(--glass); }
  .ctx-item.danger { color:#ff9090; }
  .ctx-item.danger:hover { background:rgba(255,80,80,0.2); }
  .ctx-sep { height:1px; background:var(--glass-border); margin:3px 0; }

  /* Toast */
  #toast { position:fixed; bottom:90px; right:24px; z-index:400; background:rgba(16,163,127,0.9); backdrop-filter:blur(10px); padding:12px 20px; border-radius:12px; font-size:13px; transform:translateY(20px); opacity:0; transition:all 0.3s; border:1px solid rgba(16,163,127,0.5); }
  #toast.show { transform:translateY(0); opacity:1; }

  /* Whisper badge */
  .whisper-badge { display:inline-flex; align-items:center; gap:4px; font-size:10px; padding:2px 8px; border-radius:10px; background:rgba(16,163,127,0.2); border:1px solid rgba(16,163,127,0.4); color:#4ade80; margin-bottom:6px; }
</style>
</head>
<body>

<div id="sky-bg"></div>
<div id="stars"></div>

<div id="app">
  <!-- Sidebar -->
  <div id="sidebar">
    <div id="sidebar-header">
      <div class="logo">SKY AI</div>
      <div class="logo-sub">CHAT</div>
      <div class="logo-badge">âœ¦ Powered by OpenAI</div>
    </div>
    <button id="new-chat-btn" onclick="newChat()"><span>âœ¦</span> æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</button>

    <div id="mode-tabs">
      <div class="mode-tab active" data-mode="chat" onclick="setMode('chat',this)"><span class="mode-icon">ğŸ’¬</span> AIãƒãƒ£ãƒƒãƒˆ (GPT-4o)</div>
      <div class="mode-tab" data-mode="image" onclick="setMode('image',this)"><span class="mode-icon">ğŸ¨</span> ç”»åƒç”Ÿæˆ (DALL-E 3)</div>
      <div class="mode-tab" data-mode="video" onclick="setMode('video',this)"><span class="mode-icon">ğŸ¬</span> å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>
      <div class="mode-tab" data-mode="pdf" onclick="setMode('pdf',this)"><span class="mode-icon">ğŸ“„</span> PDFç”Ÿæˆ</div>
      <div class="mode-tab" data-mode="pptx" onclick="setMode('pptx',this)"><span class="mode-icon">ğŸ“Š</span> PPTXç”Ÿæˆ</div>
    </div>

    <div class="separator"></div>

    <div id="history-list">
      <div class="history-section-label">
        æœ€è¿‘ã®ä¼šè©±
        <button class="clear-all-btn" onclick="confirmClearAll()">å…¨ã¦å‰Šé™¤</button>
      </div>
      <div id="history-items"></div>
    </div>
  </div>

  <!-- Main -->
  <div id="main">
    <div id="topbar">
      <div id="mode-title">ğŸ’¬ AIãƒãƒ£ãƒƒãƒˆ</div>
      <div class="topbar-right">
        <select id="model-select">
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4o-mini">GPT-4o mini</option>
          <option value="gpt-4-turbo">GPT-4 Turbo</option>
          <option value="o1-mini">o1-mini</option>
        </select>
        <button class="icon-btn" id="tts-btn" onclick="toggleTTS()" title="TTS èª­ã¿ä¸Šã’ ON/OFF">ğŸ”Š</button>
        <button class="icon-btn" onclick="toggleApiModal()" title="APIè¨­å®š">âš™ï¸</button>
      </div>
    </div>

    <div id="chat-area">
      <div id="welcome">
        <div class="welcome-logo">SKY AI CHAT</div>
        <div class="welcome-sub">ã‚ãªãŸã®çŸ¥æ€§ã®ç©ºé–“ã¸ã‚ˆã†ã“ã</div>
        <div class="welcome-powered">âœ¦ Powered by OpenAI GPT-4o Â· DALL-E 3 Â· Whisper Â· TTS</div>
        <div class="quick-actions">
          <button class="quick-btn" onclick="quickSend('æ—¥æœ¬ã®æ–‡åŒ–ã¨æ­´å²ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„')">
            <span class="qb-icon">ğŸ¯</span>æ—¥æœ¬ã®æ–‡åŒ–ã«ã¤ã„ã¦æ•™ãˆã¦
          </button>
          <button class="quick-btn" onclick="setMode('image',document.querySelector('[data-mode=image]'));quickSend('ç¾ã—ã„å¤•ç„¼ã‘ã¨å¯Œå£«å±±ã®é¢¨æ™¯ã€å†™å®Ÿçš„')">
            <span class="qb-icon">ğŸ¨</span>å¯Œå£«å±±ã®ç”»åƒã‚’ç”Ÿæˆ
          </button>
          <button class="quick-btn" onclick="setMode('pdf',document.querySelector('[data-mode=pdf]'));quickSend('AIã®æœªæ¥ã«ã¤ã„ã¦ã®ãƒ¬ãƒãƒ¼ãƒˆ')">
            <span class="qb-icon">ğŸ“„</span>AIãƒ¬ãƒãƒ¼ãƒˆã‚’PDFã§ä½œæˆ
          </button>
          <button class="quick-btn" onclick="setMode('pptx',document.querySelector('[data-mode=pptx]'));quickSend('ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã®ãƒ—ãƒ¬ã‚¼ãƒ³')">
            <span class="qb-icon">ğŸ“Š</span>ãƒ—ãƒ¬ã‚¼ãƒ³è³‡æ–™ã‚’ä½œæˆ
          </button>
        </div>
      </div>
    </div>

    <div id="input-area">
      <div id="mode-options"></div>
      <div id="attachments-bar"></div>
      <div id="input-row">
        <button class="input-btn" id="attach-btn" onclick="openFileDialog()" title="ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜">ğŸ“</button>
        <button class="input-btn" id="voice-btn" onclick="toggleVoice()" title="WhisperéŸ³å£°å…¥åŠ›">ğŸ¤</button>
        <textarea id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›... (Shift+Enterã§æ”¹è¡Œ)" rows="1"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="input-btn" id="send-btn" onclick="sendMessage()">â¤</button>
      </div>
      <input type="file" id="file-input" multiple
        accept="image/*,.pdf,.txt,.md,.csv,.json,.html,.js,.py,.docx"
        onchange="handleFileSelect(event)">
      <div class="input-hint">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ ï½œ ğŸ¤ WhisperéŸ³å£°å…¥åŠ› ï½œ ğŸ”Š TTSèª­ã¿ä¸Šã’ ï½œ Shift+Enterã§æ”¹è¡Œ</div>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div id="ctx-menu">
  <div class="ctx-item" onclick="ctxRename()">âœï¸ åå‰ã‚’å¤‰æ›´</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" onclick="ctxDelete()">ğŸ—‘ï¸ å‰Šé™¤</div>
</div>

<!-- API Key Modal -->
<div id="api-modal" class="modal-overlay open">
  <div class="modal-box">
    <div class="modal-title">OpenAI API è¨­å®š</div>
    <div class="modal-desc">
      Sky AI Chatã¯OpenAI APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
      APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
    </div>
    <label class="modal-label">OpenAI APIã‚­ãƒ¼</label>
    <input type="password" class="modal-input" id="api-key-input" placeholder="sk-..." />

    <div class="modal-divider"></div>
    <div class="modal-desc" style="margin-bottom:12px">
      ğŸ’¡ <strong style="color:white">å…¬é–‹ã™ã‚‹å ´åˆã®æ³¨æ„</strong><br>
      ã“ã®ã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã™ã‚‹ã¨ã€é–²è¦§è€…ã¯è‡ªåˆ†ã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ä½¿ãˆã¾ã™ã€‚<br>
      Vercelãƒ»Netlifyãƒ»GitHub Pagesã«<code style="color:#87ceeb">HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</code>ã™ã‚‹ã ã‘ã§å…¬é–‹ã§ãã¾ã™ã€‚
    </div>
    <button class="modal-btn" onclick="saveApiKey()">ä¿å­˜ã—ã¦é–‹å§‹</button>
    <div class="modal-note">
      APIã‚­ãƒ¼ã¯ <a href="https://platform.openai.com/api-keys" target="_blank" style="color:#4ade80">platform.openai.com</a> ã§å–å¾—ã§ãã¾ã™
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div id="rename-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title">ä¼šè©±åã‚’å¤‰æ›´</div>
    <div class="modal-desc">æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    <input type="text" class="modal-input" id="rename-input" placeholder="ä¼šè©±å..." maxlength="50"
      onkeydown="if(event.key==='Enter') confirmRename()" />
    <div class="modal-btn-row">
      <button class="modal-btn secondary" onclick="closeRenameModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn" onclick="confirmRename()">å¤‰æ›´ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title">å‰Šé™¤ã®ç¢ºèª</div>
    <div class="modal-desc" id="delete-modal-desc">ã“ã®ä¼šè©±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
    <div class="modal-btn-row">
      <button class="modal-btn secondary" onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn danger" onclick="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ===== State =====
let currentMode = 'chat';
let messages = []; // OpenAI format
let chatHistory = JSON.parse(localStorage.getItem('sky_history_v2') || '[]');
let currentChatId = Date.now();
let isLoading = false;
let attachedFiles = [];
let ttsEnabled = false;
let ctxTargetId = null;
let deleteTargetId = null;
let deleteClearAll = false;

// Whisper recording
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

const modeOptions = {
  chat: [],
  image: ['å†™å®Ÿçš„', 'ã‚¢ãƒ‹ãƒ¡é¢¨', 'æ°´å½©ç”»', 'æ²¹çµµ', 'ãƒ‰ãƒƒãƒˆçµµ', 'ãƒŸãƒ‹ãƒãƒ«', 'æ˜ ç”»çš„'],
  video: ['çŸ­ç·¨(5ç§’)', 'ä¸­ç·¨(15ç§’)', 'ãƒ«ãƒ¼ãƒ—', 'ã‚¹ãƒ­ãƒ¼ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³', 'ã‚¿ã‚¤ãƒ ãƒ©ãƒ—ã‚¹'],
  pdf:  ['ãƒ¬ãƒãƒ¼ãƒˆ', 'è­°äº‹éŒ²', 'ææ¡ˆæ›¸', 'ã‚¨ãƒƒã‚»ã‚¤', 'æŠ€è¡“æ–‡æ›¸'],
  pptx: ['ãƒ“ã‚¸ãƒã‚¹', 'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–', 'ã‚·ãƒ³ãƒ—ãƒ«', 'ãƒ€ãƒ¼ã‚¯', 'ã‚«ãƒ©ãƒ•ãƒ«']
};
const modeTitles   = { chat:'ğŸ’¬ AIãƒãƒ£ãƒƒãƒˆ', image:'ğŸ¨ ç”»åƒç”Ÿæˆ (DALL-E 3)', video:'ğŸ¬ å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ', pdf:'ğŸ“„ PDFç”Ÿæˆ', pptx:'ğŸ“Š PPTXç”Ÿæˆ' };
const modePlaceholders = {
  chat: 'GPT-4oã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹...',
  image: 'ç”Ÿæˆã—ãŸã„ç”»åƒã‚’èª¬æ˜ã—ã¦ãã ã•ã„... (ä¾‹: å¤•ç„¼ã‘ã®æµ·ã€æ°´å½©ç”»é¢¨)',
  video: 'å‹•ç”»ã®ã‚·ãƒ¼ãƒ³ã‚’èª¬æ˜ã—ã¦ãã ã•ã„...',
  pdf:  'PDFã®å†…å®¹ã‚„æŒ‡ç¤ºã‚’å…¥åŠ›...',
  pptx: 'ãƒ—ãƒ¬ã‚¼ãƒ³ã®ãƒ†ãƒ¼ãƒã‚„å†…å®¹ã‚’å…¥åŠ›...'
};
const modeIcons = { chat:'ğŸ’¬', image:'ğŸ¨', video:'ğŸ¬', pdf:'ğŸ“„', pptx:'ğŸ“Š' };

// ===== Init =====
function init() {
  createStars(); createClouds();
  const savedKey = localStorage.getItem('sky_openai_key');
  if (savedKey) {
    document.getElementById('api-modal').classList.remove('open');
    document.getElementById('api-key-input').value = savedKey;
  }
  ttsEnabled = localStorage.getItem('sky_tts') === '1';
  if (ttsEnabled) document.getElementById('tts-btn').classList.add('active');
  renderHistory();
  setMode('chat', document.querySelector('[data-mode=chat]'));
  document.addEventListener('click', e => {
    if (!document.getElementById('ctx-menu').contains(e.target))
      document.getElementById('ctx-menu').classList.remove('open');
  });
}

function createStars() {
  const c = document.getElementById('stars');
  for (let i=0;i<80;i++) {
    const s=document.createElement('div'); s.className='star';
    const sz=Math.random()*2.5+0.5;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*60}%;--d:${2+Math.random()*4}s;animation-delay:${Math.random()*4}s;`;
    c.appendChild(s);
  }
}
function createClouds() {
  [{top:'15%',w:300,h:80,op:0.35,dur:'35s',dl:'0s'},{top:'25%',w:200,h:60,op:0.2,dur:'50s',dl:'10s'},
   {top:'60%',w:400,h:100,op:0.18,dur:'45s',dl:'5s'},{top:'70%',w:250,h:70,op:0.25,dur:'55s',dl:'20s'}]
  .forEach(p=>{
    const c=document.createElement('div'); c.className='cloud';
    c.style.cssText=`top:${p.top};width:${p.w}px;height:${p.h}px;opacity:${p.op};--cd:${p.dur};animation-delay:-${p.dl};`;
    document.body.appendChild(c);
  });
}

// ===== API Key =====
function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key.startsWith('sk-')) { showToast('âŒ æœ‰åŠ¹ãªAPIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  localStorage.setItem('sky_openai_key', key);
  document.getElementById('api-modal').classList.remove('open');
  showToast('âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
function toggleApiModal() { document.getElementById('api-modal').classList.toggle('open'); }
function getApiKey() { return localStorage.getItem('sky_openai_key') || ''; }

// ===== TTS Toggle =====
function toggleTTS() {
  ttsEnabled = !ttsEnabled;
  localStorage.setItem('sky_tts', ttsEnabled ? '1' : '0');
  document.getElementById('tts-btn').classList.toggle('active', ttsEnabled);
  showToast(ttsEnabled ? 'ğŸ”Š TTS èª­ã¿ä¸Šã’ ON' : 'ğŸ”‡ TTS èª­ã¿ä¸Šã’ OFF');
}

// ===== Mode =====
function setMode(mode, el) {
  currentMode = mode;
  document.querySelectorAll('.mode-tab').forEach(t=>t.classList.remove('active'));
  if (el) el.classList.add('active');
  document.getElementById('mode-title').textContent = modeTitles[mode];
  document.getElementById('msg-input').placeholder = modePlaceholders[mode];
  const container = document.getElementById('mode-options');
  container.innerHTML = '';
  modeOptions[mode].forEach(o=>{
    const chip=document.createElement('div'); chip.className='option-chip'; chip.textContent=o;
    chip.onclick=()=>chip.classList.toggle('selected');
    container.appendChild(chip);
  });
  // Show/hide DALL-E size options for image mode
  if (mode==='image') {
    ['1024x1024','1792x1024','1024x1792'].forEach(sz=>{
      const chip=document.createElement('div'); chip.className='option-chip';
      chip.textContent=sz; chip.dataset.size=sz;
      if (sz==='1024x1024') chip.classList.add('selected');
      chip.onclick=()=>{
        document.querySelectorAll('.option-chip[data-size]').forEach(c=>c.classList.remove('selected'));
        chip.classList.add('selected');
      };
      container.appendChild(chip);
    });
  }
}

// ===== File Attachment =====
function openFileDialog() { document.getElementById('file-input').click(); }
async function handleFileSelect(event) {
  for (const file of Array.from(event.target.files)) {
    if (file.size > 25*1024*1024) { showToast(`âŒ ${file.name} ã¯25MBã‚’è¶…ãˆã¦ã„ã¾ã™`); continue; }
    const dataUrl = await readFileAsDataUrl(file);
    const base64 = dataUrl.split(',')[1];
    attachedFiles.push({ name:file.name, type:file.type, size:file.size, dataUrl, base64, mediaType:file.type||'application/octet-stream' });
  }
  event.target.value = '';
  renderAttachmentsBar();
}
function readFileAsDataUrl(file) {
  return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); });
}
function renderAttachmentsBar() {
  const bar = document.getElementById('attachments-bar');
  bar.innerHTML = '';
  if (!attachedFiles.length) { bar.classList.remove('has-files'); return; }
  bar.classList.add('has-files');
  attachedFiles.forEach((f,i)=>{
    const chip=document.createElement('div'); chip.className='attach-chip';
    const icon=f.type.startsWith('image/')?'ğŸ–¼ï¸':f.type==='application/pdf'?'ğŸ“„':'ğŸ“';
    chip.innerHTML=`<span class="attach-chip-icon">${icon}</span><span class="attach-chip-name" title="${f.name}">${f.name}</span><button class="attach-chip-remove" onclick="removeAttachment(${i})">âœ•</button>`;
    bar.appendChild(chip);
  });
}
function removeAttachment(i) { attachedFiles.splice(i,1); renderAttachmentsBar(); }
function getFileIcon(type) { return type.startsWith('image/')?'ğŸ–¼ï¸':type==='application/pdf'?'ğŸ“„':'ğŸ“'; }
function formatSize(b) { return b<1024?b+' B':b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB'; }

// ===== Chat =====
function newChat() {
  messages=[]; currentChatId=Date.now(); attachedFiles=[];
  renderAttachmentsBar();
  document.getElementById('chat-area').innerHTML = `
    <div id="welcome">
      <div class="welcome-logo">SKY AI CHAT</div>
      <div class="welcome-sub">ã‚ãªãŸã®çŸ¥æ€§ã®ç©ºé–“ã¸ã‚ˆã†ã“ã</div>
      <div class="welcome-powered">âœ¦ Powered by OpenAI GPT-4o Â· DALL-E 3 Â· Whisper Â· TTS</div>
      <div class="quick-actions">
        <button class="quick-btn" onclick="quickSend('æ—¥æœ¬ã®æ–‡åŒ–ã¨æ­´å²ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„')"><span class="qb-icon">ğŸ¯</span>æ—¥æœ¬ã®æ–‡åŒ–ã«ã¤ã„ã¦</button>
        <button class="quick-btn" onclick="setMode('image',document.querySelector('[data-mode=image]'));quickSend('ç¾ã—ã„å¤•ç„¼ã‘ã¨å¯Œå£«å±±ã€å†™å®Ÿçš„')"><span class="qb-icon">ğŸ¨</span>å¯Œå£«å±±ã®ç”»åƒã‚’ç”Ÿæˆ</button>
        <button class="quick-btn" onclick="setMode('pdf',document.querySelector('[data-mode=pdf]'));quickSend('AIã®æœªæ¥ã«ã¤ã„ã¦ã®ãƒ¬ãƒãƒ¼ãƒˆ')"><span class="qb-icon">ğŸ“„</span>AIãƒ¬ãƒãƒ¼ãƒˆã‚’PDFã§ä½œæˆ</button>
        <button class="quick-btn" onclick="setMode('pptx',document.querySelector('[data-mode=pptx]'));quickSend('ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã®ãƒ—ãƒ¬ã‚¼ãƒ³')"><span class="qb-icon">ğŸ“Š</span>ãƒ—ãƒ¬ã‚¼ãƒ³è³‡æ–™ã‚’ä½œæˆ</button>
      </div>
    </div>`;
  renderHistory();
}

function quickSend(text) { document.getElementById('msg-input').value=text; sendMessage(); }

async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  const hasFiles = attachedFiles.length > 0;
  if ((!text && !hasFiles) || isLoading) return;
  const apiKey = getApiKey();
  if (!apiKey) { toggleApiModal(); return; }

  const welcome = document.getElementById('welcome');
  if (welcome) welcome.remove();

  const currentFiles = [...attachedFiles];
  addMessage('user', text, null, currentFiles);
  attachedFiles=[]; renderAttachmentsBar();
  input.value=''; autoResize(input);

  const selectedOpts = [...document.querySelectorAll('.option-chip.selected')].map(c=>c.textContent);
  const selectedSize = document.querySelector('.option-chip[data-size].selected')?.dataset.size || '1024x1024';

  isLoading=true; document.getElementById('send-btn').disabled=true;
  const typingId = addTyping();

  try {
    if (currentMode==='image') {
      await handleImageGeneration(text, selectedOpts, selectedSize, apiKey);
    } else {
      const userMsg = buildOpenAIMessage(text, currentFiles);
      messages.push({ role:'user', content: userMsg });
      const response = await callGPT(selectedOpts, apiKey);
      removeTyping(typingId);
      await displayResponse(response, text, selectedOpts);
    }
    if (currentMode==='image') removeTyping(typingId);
    saveToHistory(text || currentFiles[0]?.name || 'æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«');
  } catch(e) {
    removeTyping(typingId);
    addMessage('ai', `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`);
    console.error(e);
  }

  isLoading=false; document.getElementById('send-btn').disabled=false;
}

function buildOpenAIMessage(text, files) {
  if (!files.length) return text;
  const content = [];
  files.forEach(f => {
    if (f.type.startsWith('image/')) {
      content.push({ type:'image_url', image_url:{ url:`data:${f.mediaType};base64,${f.base64}` } });
    } else {
      try {
        const utf8 = decodeURIComponent(escape(atob(f.base64)));
        content.push({ type:'text', text:`ã€æ·»ä»˜: ${f.name}ã€‘\n${utf8}\nã€çµ‚äº†ã€‘` });
      } catch {
        content.push({ type:'text', text:`ã€æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: ${f.name}ã€‘` });
      }
    }
  });
  if (text) content.push({ type:'text', text });
  return content;
}

async function callGPT(opts, apiKey) {
  let systemContent = 'ã‚ãªãŸã¯ã€ŒSky AIã€ã§ã™ã€‚æ—¥æœ¬èªã§ä¸å¯§ã‹ã¤åˆ†ã‹ã‚Šã‚„ã™ãå›ç­”ã—ã¦ãã ã•ã„ã€‚';
  if (currentMode==='pdf') {
    systemContent = `ã‚ãªãŸã¯PDFæ–‡æ›¸ä½œæˆAIã§ã™ã€‚Markdownå½¢å¼ã§å®Œå…¨ãªæ–‡æ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚æ–‡æ›¸ã‚¿ã‚¤ãƒ—: ${opts.filter(o=>!o.includes('x')).join(', ') || 'ãƒ¬ãƒãƒ¼ãƒˆ'}ã€‚`;
  } else if (currentMode==='pptx') {
    systemContent = `ã‚ãªãŸã¯ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆAIã§ã™ã€‚ä»¥ä¸‹ã®JSONå½¢å¼ã§ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ã‚¹ã‚¿ã‚¤ãƒ«: ${opts.join(', ') || 'ãƒ“ã‚¸ãƒã‚¹'}ã€‚
{"title":"ã‚¿ã‚¤ãƒˆãƒ«","slides":[{"title":"ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«","content":"æœ¬æ–‡","bullets":["è¦ç‚¹1","è¦ç‚¹2"]}]}
JSONä»¥å¤–ã¯å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚`;
  } else if (currentMode==='video') {
    systemContent = `ã‚ãªãŸã¯å‹•ç”»ç”ŸæˆAIã§ã™ã€‚Soraãªã©ã§ä½¿ãˆã‚‹è©³ç´°ãªå‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨çµµã‚³ãƒ³ãƒ†ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚å½¢å¼: ${opts.join(', ') || 'çŸ­ç·¨'}ã€‚`;
  }

  const model = document.getElementById('model-select').value;
  const body = {
    model,
    messages: [{ role:'system', content:systemContent }, ...messages],
    max_tokens: 2048,
    temperature: 0.7
  };

  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
    body: JSON.stringify(body)
  });
  if (!res.ok) { const e=await res.json(); throw new Error(e.error?.message || `HTTP ${res.status}`); }
  const data = await res.json();
  return data.choices[0].message.content;
}

async function handleImageGeneration(prompt, opts, size, apiKey) {
  const styleOpts = opts.filter(o=>!o.includes('x'));
  const fullPrompt = styleOpts.length ? `${prompt}, ${styleOpts.join(', ')}` : prompt;

  const res = await fetch('https://api.openai.com/v1/images/generations', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
    body: JSON.stringify({
      model: 'dall-e-3',
      prompt: fullPrompt,
      n: 1,
      size,
      quality: 'standard',
      response_format: 'url'
    })
  });
  if (!res.ok) { const e=await res.json(); throw new Error(e.error?.message || `HTTP ${res.status}`); }
  const data = await res.json();
  const imageUrl = data.data[0].url;
  const revisedPrompt = data.data[0].revised_prompt || '';
  addMessage('ai', revisedPrompt ? `âœ¨ æ”¹å–„ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:\n${revisedPrompt}` : 'ğŸ¨ ç”»åƒã‚’ç”Ÿæˆã—ã¾ã—ãŸ', { type:'dalle_image', url:imageUrl });
}

async function displayResponse(text, userText, opts) {
  if (currentMode==='chat') {
    addMessage('ai', text);
    messages.push({ role:'assistant', content:text });
    if (ttsEnabled) await speakTTS(text, getApiKey());
  } else if (currentMode==='video') {
    addMessage('ai', text, { type:'video' });
  } else if (currentMode==='pdf') {
    addMessage('ai', 'ğŸ“„ PDFã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', { type:'pdf', content:text });
  } else if (currentMode==='pptx') {
    addMessage('ai', 'ğŸ“Š ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', { type:'pptx', content:text });
  }
}

// ===== TTS via OpenAI =====
async function speakTTS(text, apiKey) {
  if (!text || !apiKey) return;
  const shortText = text.slice(0, 500);
  try {
    const res = await fetch('https://api.openai.com/v1/audio/speech', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
      body: JSON.stringify({ model:'tts-1', voice:'nova', input:shortText, speed:1.0 })
    });
    if (!res.ok) return;
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    audio.play();
  } catch(e) { console.error('TTS error:', e); }
}

// ===== Whisper Voice Input =====
function toggleVoice() { isRecording ? stopWhisper() : startWhisper(); }

async function startWhisper() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: getSupportedMimeType() });
    mediaRecorder.ondataavailable = e => { if (e.data.size>0) audioChunks.push(e.data); };
    mediaRecorder.onstop = async () => {
      stream.getTracks().forEach(t=>t.stop());
      await transcribeWithWhisper();
    };
    mediaRecorder.start();
    isRecording=true;
    document.getElementById('voice-btn').classList.add('recording');
    document.getElementById('voice-btn').textContent='â¹ï¸';
    showToast('ğŸ¤ éŒ²éŸ³ä¸­... ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦åœæ­¢');
  } catch(e) {
    showToast('âŒ ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã¾ã›ã‚“: ' + e.message);
  }
}

function getSupportedMimeType() {
  const types = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
  return types.find(t=>MediaRecorder.isTypeSupported(t)) || '';
}

function stopWhisper() {
  if (mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop();
  isRecording=false;
  document.getElementById('voice-btn').classList.remove('recording');
  document.getElementById('voice-btn').textContent='ğŸ¤';
}

async function transcribeWithWhisper() {
  const apiKey = getApiKey();
  if (!apiKey) { showToast('âŒ APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™'); return; }
  showToast('â³ Whisperã§æ–‡å­—èµ·ã“ã—ä¸­...');

  const mimeType = getSupportedMimeType() || 'audio/webm';
  const ext = mimeType.includes('mp4')?'mp4':mimeType.includes('ogg')?'ogg':'webm';
  const blob = new Blob(audioChunks, { type:mimeType });
  const formData = new FormData();
  formData.append('file', blob, `recording.${ext}`);
  formData.append('model', 'whisper-1');
  formData.append('language', 'ja');

  try {
    const res = await fetch('https://api.openai.com/v1/audio/transcriptions', {
      method:'POST',
      headers:{ 'Authorization':`Bearer ${apiKey}` },
      body: formData
    });
    if (!res.ok) { const e=await res.json(); throw new Error(e.error?.message); }
    const data = await res.json();
    const transcript = data.text.trim();
    document.getElementById('msg-input').value = transcript;
    autoResize(document.getElementById('msg-input'));
    showToast('âœ… æ–‡å­—èµ·ã“ã—å®Œäº†');

    // Show whisper badge
    const badge = document.createElement('div');
    badge.className='whisper-badge';
    badge.innerHTML='ğŸ¤ Whisper æ–‡å­—èµ·ã“ã—';
    document.getElementById('input-area').insertBefore(badge, document.getElementById('attachments-bar'));
    setTimeout(()=>badge.remove(), 3000);
  } catch(e) {
    showToast('âŒ æ–‡å­—èµ·ã“ã—ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

// ===== Message Rendering =====
function addMessage(role, text, extra, files) {
  const chatArea = document.getElementById('chat-area');
  const div = document.createElement('div');
  div.className=`msg ${role}`;

  const avatar=document.createElement('div'); avatar.className='msg-avatar';
  avatar.textContent=role==='ai'?'âœ¦':'ğŸ‘¤';

  const bubble=document.createElement('div'); bubble.className='msg-bubble';

  if (files && files.length) {
    files.forEach(f=>{
      const fp=document.createElement('div'); fp.className='file-preview-msg';
      if (f.type.startsWith('image/')) {
        fp.innerHTML=`<img src="${f.dataUrl}" alt="${f.name}">`;
      } else {
        fp.innerHTML=`<span class="fp-icon">${getFileIcon(f.type)}</span><div><div class="fp-name">${f.name}</div><div class="fp-size">${formatSize(f.size)}</div></div>`;
      }
      bubble.appendChild(fp);
    });
  }

  if (text) {
    const textEl=document.createElement('div');
    textEl.innerHTML=renderMarkdown(text);
    bubble.appendChild(textEl);
  }

  if (extra) {
    const preview=document.createElement('div'); preview.className='gen-preview';
    if (extra.type==='dalle_image') {
      preview.innerHTML=`<div class="dalle-result"><img src="${extra.url}" alt="DALL-E ç”Ÿæˆç”»åƒ" onload="scrollChatBottom()"></div>`;
      const dlBtn=document.createElement('button'); dlBtn.className='download-btn'; dlBtn.textContent='â¬‡ï¸ ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
      dlBtn.onclick=()=>{ const a=document.createElement('a'); a.href=extra.url; a.download='dalle-image.png'; a.target='_blank'; a.click(); };
      preview.appendChild(dlBtn);
      bubble.innerHTML=''; bubble.appendChild(preview);
    } else if (extra.type==='pdf') {
      preview.innerHTML=`<div style="color:var(--text-dim);font-size:11px;margin-bottom:4px">ğŸ“„ PDFç”Ÿæˆå®Œäº†</div>`;
      const btn=document.createElement('button'); btn.className='download-btn'; btn.textContent='â¬‡ï¸ HTMLã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
      btn.onclick=()=>generateHTMLDoc(extra.content);
      preview.appendChild(btn); bubble.appendChild(preview);
    } else if (extra.type==='pptx') {
      preview.innerHTML=`<div style="color:var(--text-dim);font-size:11px;margin-bottom:4px">ğŸ“Š PPTXç”Ÿæˆå®Œäº†</div>`;
      const btn=document.createElement('button'); btn.className='download-btn'; btn.textContent='â¬‡ï¸ HTMLã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
      btn.onclick=()=>generateHTMLPPTX(extra.content);
      preview.appendChild(btn); bubble.appendChild(preview);
    } else if (extra.type==='video') {
      const btn=document.createElement('button'); btn.className='download-btn'; btn.textContent='ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼';
      btn.onclick=()=>{ navigator.clipboard.writeText(text); btn.textContent='âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼'; setTimeout(()=>btn.textContent='ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼',2000); };
      preview.innerHTML=`<div style="color:var(--text-dim);font-size:11px;margin-bottom:4px">ğŸ¬ å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆå®Œäº†</div>`;
      preview.appendChild(btn); bubble.appendChild(preview);
    }
  }

  if (role==='ai') { div.appendChild(avatar); div.appendChild(bubble); }
  else { div.appendChild(bubble); div.appendChild(avatar); }

  chatArea.appendChild(div);
  scrollChatBottom();
  return div;
}

function scrollChatBottom() {
  const c=document.getElementById('chat-area');
  c.scrollTop=c.scrollHeight;
}

function renderMarkdown(text) {
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/```([\s\S]*?)```/g,'<pre><code>$1</code></pre>')
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/^### (.*)/gm,'<h3 style="color:#87ceeb;margin:8px 0 4px">$1</h3>')
    .replace(/^## (.*)/gm,'<h2 style="color:#87ceeb;margin:10px 0 6px">$1</h2>')
    .replace(/^# (.*)/gm,'<h1 style="color:#87ceeb;margin:12px 0 8px">$1</h1>')
    .replace(/^- (.*)/gm,'<li style="margin:2px 0;padding-left:4px">$1</li>')
    .replace(/\n/g,'<br>');
}

function addTyping() {
  const chatArea=document.getElementById('chat-area');
  const id='typing-'+Date.now();
  const div=document.createElement('div'); div.className='msg ai'; div.id=id;
  div.innerHTML=`<div class="msg-avatar">âœ¦</div><div class="msg-bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div>`;
  chatArea.appendChild(div); scrollChatBottom();
  return id;
}
function removeTyping(id) { const el=document.getElementById(id); if(el) el.remove(); }

// ===== PDF / PPTX =====
function generateHTMLDoc(content) {
  const lines=content.split('\n');
  let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:'Noto Sans JP','Helvetica Neue',sans-serif;max-width:800px;margin:40px auto;padding:20px;color:#333;line-height:1.8}h1{color:#1a3a6b;border-bottom:3px solid #10a37f;padding-bottom:10px}h2{color:#10a37f;border-left:4px solid #87ceeb;padding-left:12px}@media print{body{margin:0}}</style></head><body>`;
  lines.forEach(l=>{
    if(l.startsWith('# '))html+=`<h1>${l.slice(2)}</h1>`;
    else if(l.startsWith('## '))html+=`<h2>${l.slice(3)}</h2>`;
    else if(l.startsWith('### '))html+=`<h3>${l.slice(4)}</h3>`;
    else if(l.startsWith('- ')||l.startsWith('* '))html+=`<li>${l.slice(2)}</li>`;
    else if(l.trim())html+=`<p>${l}</p>`;
    else html+='<br>';
  });
  html+='</body></html>';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([html],{type:'text/html'}));
  a.download='sky-ai-document.html'; a.click();
  showToast('ğŸ“„ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦å°åˆ·â†’PDFä¿å­˜ï¼‰');
}

function generateHTMLPPTX(content) {
  let slides;
  try { const m=content.match(/\{[\s\S]*\}/); if(m) slides=JSON.parse(m[0]); } catch(e){}
  if (!slides) { showToast('âŒ JSONè§£æã‚¨ãƒ©ãƒ¼'); return; }
  let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans JP',sans-serif;background:#0a0f2e;color:white}.slide{width:960px;min-height:540px;margin:20px auto;padding:60px;background:linear-gradient(135deg,#1a3a6b,#0d5c45);border-radius:12px;page-break-after:always;position:relative;overflow:hidden}.slide::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 80% 20%,rgba(16,163,127,0.15) 0%,transparent 60%)}.slide-num{position:absolute;top:20px;right:24px;font-size:12px;opacity:0.5}h1{font-size:40px;font-weight:300;letter-spacing:3px;margin-bottom:24px;background:linear-gradient(135deg,#87ceeb,#4ade80);-webkit-background-clip:text;-webkit-text-fill-color:transparent}h2{font-size:26px;font-weight:400;letter-spacing:2px;margin-bottom:20px;border-bottom:2px solid rgba(16,163,127,0.4);padding-bottom:10px}p{font-size:16px;line-height:1.9;opacity:0.9;margin-bottom:12px}ul{list-style:none}li{font-size:15px;line-height:1.8;padding:6px 0 6px 24px;position:relative}li::before{content:'â—†';position:absolute;left:0;color:#4ade80;font-size:10px;top:10px}@media print{.slide{margin:0;border-radius:0}}</style></head><body>`;
  html+=`<div class="slide"><div class="slide-num">1 / ${(slides.slides?.length||0)+1}</div><h1>${slides.title||'ãƒ—ãƒ¬ã‚¼ãƒ³'}</h1><p style="letter-spacing:3px;opacity:0.5;font-size:12px">SKY AI CHAT â€” OpenAI powered</p></div>`;
  (slides.slides||[]).forEach((s,i)=>{
    html+=`<div class="slide"><div class="slide-num">${i+2} / ${slides.slides.length+1}</div><h2>${s.title||''}</h2>${s.content?`<p>${s.content}</p>`:''}${s.bullets?`<ul>${s.bullets.map(b=>`<li>${b}</li>`).join('')}</ul>`:''}</div>`;
  });
  html+='</body></html>';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([html],{type:'text/html'}));
  a.download='sky-ai-presentation.html'; a.click();
  showToast('ğŸ“Š ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†');
}

// ===== History =====
function saveToHistory(text) {
  const title=String(text).slice(0,30)+(String(text).length>30?'...':'');
  const idx=chatHistory.findIndex(h=>h.id===currentChatId);
  if (idx>=0) { if(!chatHistory[idx].renamed) chatHistory[idx].title=title; }
  else chatHistory.unshift({id:currentChatId,title,date:new Date().toLocaleDateString('ja-JP'),mode:currentMode,renamed:false});
  if(chatHistory.length>50) chatHistory.pop();
  localStorage.setItem('sky_history_v2',JSON.stringify(chatHistory));
  renderHistory();
}

function renderHistory() {
  const container=document.getElementById('history-items');
  container.innerHTML='';
  chatHistory.slice(0,30).forEach(h=>{
    const div=document.createElement('div');
    div.className='history-item'+(h.id===currentChatId?' active':'');
    div.dataset.id=h.id;

    const icon=document.createElement('span'); icon.className='history-item-icon';
    icon.textContent=modeIcons[h.mode]||'ğŸ’¬';

    const title=document.createElement('span'); title.className='history-item-title';
    title.textContent=h.title; title.title=h.title;

    const actions=document.createElement('div'); actions.className='history-actions';
    actions.innerHTML=`<button class="h-action-btn" title="åå‰å¤‰æ›´" onclick="startRename(${h.id},event)">âœï¸</button><button class="h-action-btn delete" title="å‰Šé™¤" onclick="startDelete(${h.id},event)">ğŸ—‘ï¸</button>`;

    div.appendChild(icon); div.appendChild(title); div.appendChild(actions);
    div.addEventListener('contextmenu',e=>{e.preventDefault();showContextMenu(e.clientX,e.clientY,h.id);});
    container.appendChild(div);
  });
}

// ===== Rename =====
function startRename(id, event) {
  if(event) event.stopPropagation();
  ctxTargetId=id;
  const h=chatHistory.find(x=>x.id===id); if(!h) return;
  const input=document.getElementById('rename-input');
  input.value=h.title.replace(/\.\.\.$/,'');
  document.getElementById('rename-modal').classList.add('open');
  setTimeout(()=>{input.focus();input.select();},100);
}
function confirmRename() {
  const name=document.getElementById('rename-input').value.trim();
  if(!name){showToast('âŒ åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const h=chatHistory.find(x=>x.id===ctxTargetId);
  if(h){h.title=name;h.renamed=true;localStorage.setItem('sky_history_v2',JSON.stringify(chatHistory));renderHistory();showToast('âœ… åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');}
  closeRenameModal();
}
function closeRenameModal(){document.getElementById('rename-modal').classList.remove('open');ctxTargetId=null;}

// ===== Delete =====
function startDelete(id, event) {
  if(event) event.stopPropagation();
  deleteTargetId=id; deleteClearAll=false;
  document.getElementById('delete-modal-desc').textContent='ã“ã®ä¼šè©±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚';
  document.getElementById('delete-modal').classList.add('open');
}
function confirmClearAll() {
  deleteTargetId=null; deleteClearAll=true;
  document.getElementById('delete-modal-desc').textContent='å…¨ã¦ã®ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ';
  document.getElementById('delete-modal').classList.add('open');
}
function confirmDelete() {
  if(deleteClearAll){chatHistory=[];newChat();}
  else{const i=chatHistory.findIndex(h=>h.id===deleteTargetId);if(i>=0)chatHistory.splice(i,1);if(deleteTargetId===currentChatId)newChat();}
  localStorage.setItem('sky_history_v2',JSON.stringify(chatHistory));
  renderHistory();
  showToast(deleteClearAll?'ğŸ—‘ï¸ å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ':'ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
  closeDeleteModal();
}
function closeDeleteModal(){document.getElementById('delete-modal').classList.remove('open');deleteTargetId=null;deleteClearAll=false;}

// ===== Context Menu =====
function showContextMenu(x,y,id) {
  ctxTargetId=id;
  const menu=document.getElementById('ctx-menu');
  menu.style.left=Math.min(x,window.innerWidth-180)+'px';
  menu.style.top=Math.min(y,window.innerHeight-100)+'px';
  menu.classList.add('open');
}
function ctxRename() {
  document.getElementById('ctx-menu').classList.remove('open');
  startRename(ctxTargetId);
}
function ctxDelete() {
  document.getElementById('ctx-menu').classList.remove('open');
  startDelete(ctxTargetId);
}

// ===== Utils =====
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,160)+'px';}
function showToast(msg){
  const t=document.getElementById('toast'); t.textContent=msg;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000);
}

init();
</script>
</body>
</html>
